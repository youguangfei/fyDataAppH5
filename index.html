<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta http-equiv="x-ua-compatible" content="IE=edge">
	<meta name="viewport"
		content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" />
	<title>邀请助力领红包</title>
	<link rel="stylesheet" href="css/addInvation.css">
	<link rel="stylesheet" href="css/helpInvation.css">
	<style type="text/css">

	</style>
</head>

<body>
	<div class="main">
		<div class="helpPageBox" id="helpPageBox">
			<div class="helpPageTop" id="helpPageTop">
				<div class="helpHomeUser" id="helpHomeUser">
					<div class="userIcon" id="helpHomeUserIcon">

					</div>
					<p></p>
				</div>
			</div>
			<div class="personNumBox">
				<span class="personNumSpan "id="personNumSpan">15623</span>
				<p>人参与助力</p>
			</div>
			<button id="oneKeyhelpBtn" class="commonInput oneKeyhelpBtn">一键助力</button>
			
			<div class="helpInvationShow" id="helpInvationShow">
				<div class="helpListTitle">
					好友助力榜
				</div>
				<div class="helpListContent" id="helpListContent">
					<img src="img/noInvationPerson.png"/>
					<p>暂时没有人助力，您人气有点低哦~</p>
				</div>
			</div>
			
			<div class="helpRuleBox">
				<p>助力规则</p>
				<p>1.只有新用户才能帮用户提前3个名次；</p>
				<p>2.成功参与助力的新用户将获得1元注册奖励；可以在钱包中兑换领取；1元注册奖励以10个享乐豆发放到钱包中；</p>
				<p>3.助力邀请在一定时间内有效，请尽快助力；</p>
				<p>4.只有注册并下载享乐秀APP登录后才完成助力。</p>
			</div>

		</div>

		<div class="mainContentBox" id="mainContentBox">
			<input type="text" class="hideInput" id="hideInput" />
			<div class="top" id="topBox">
				<div class="scrollText" id="scrollText">
					<p>手机135****4996已领取10元</p>
				</div>
			</div>
			<div class="userBox" id="userBox">
				<div class="userIcon" id="userIcon">

				</div>
				<div class="userName" id="userName">
					
				</div>
			</div>

			<div class="bottomSubmitBox" id="bottomSubmitBox">
				<input type="number" placeholder="输入手机号领取红包" class="commonInput  submitMobile" id="submitMobile">
				<p class="errorMobile" id="errorMobile">*手机号格式不正确</p>
				<button id="submitBtn1" class="commonInput submitBtn">注册享乐秀</button>
			</div>

			<div class="registerBox" id="registerBox">
				<input type="number" placeholder="输入手机号领取红包" class="commonInput submitMobile" id="submitMobile2"
					disabled="disabled">
				<div class="codeBox">
					<input type="number" placeholder="请输入验证码" class="commonInput codeInput" id="codeInput">
					<input type="button" value="获取验证码" class="commonInput sendCodeBtn" id="sendCodeBtn">
				</div>
				<div class="agreeContent">
					<i id="agreeRadio"></i>
					<span class="agreeText">
						领取表示同意
						<strong><a href="http://site.dinwee.com/server.html">《服务条款》</a></strong>
					</span>
				</div>
				<button class="commonInput submitBtn" id="submitBtn2">注册享乐秀</button>
			</div>

			<div class="registerSuccessBox" id="registerSuccessBox">
				<img src="img/registerSuccessIcon.png" alt="注册成功">
				<p>恭喜注册成功!</p>
				<button class="commonInput submitBtn" id="goAppStoreBtn">点击领取</button>
			</div>

		</div>

		<div class="messageModal" id="messageModal">
			<ul class="messageMdUl">
				<li>您已经是享乐秀用户了，</li>
				<li>邀请好友获得更多收益哦~</li>
			</ul>
			<button class="messageOkBtn" id="messageOkBtn">确定</button>
		</div>
		<div class="toastMessageModal" id="toastMessageModal">
			注册失败 !
		</div>
	</div>
</body>
<script src="js/flexible.min.js"></script>
<script src="js/jquery-1.11.3.min.js"></script>
<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script>

	(function () {
		console.log(window.devicePixelRatio)
		let clientWidth = document.documentElement.clientWidth;
		let clientHeight = document.documentElement.clientHeight;
		console.log(clientWidth)

		var applestore = 'https://apps.apple.com/cn/app/id1483878846?mt=8';
		var apkStore = 'http://a.app.qq.com/o/simple.jsp?pkgname=cn.strtec.xlb';
		// var server = 'http://39.106.93.251';
		var server='http://app.dinwee.com';

		var urlObject = getRequest();
		let parentQrcode = urlObject.parentQrcode;
		var codeInputValue = "";
		var randomLenth = 100;
		var hasSendFlag = false;
		

		//助力首页，显示助力列表
		let renderHelpUser={
			getUserDetail: function(){
				$.ajax({
					type: "GET",
					url: `${server}/user/invitationRel/getHelpUserList?parentQrcode=${parentQrcode}`,
					success: function (res) {
						console.log(res)
						if (res.code == 200 && res.data && res.data.length) {
							renderHelpUser.renderUDetailDom(res);
						}else{
							$("#helpListContent").html('<img src="img/noInvationPerson.png"/><p>暂时没有人助力，您人气有点低哦~</p>');
						}
					}
				})
			},
			renderUDetailDom(res){
				let listUser =""
				res.data.forEach((item) =>{
					listUser +=  `<li>
						<img class="fl userIcon" src="${item.icon}"></img>
						<div class="fl invationUserName">
							<p class="nameText">${item.nickName}</p>
							<p>获得1元注册奖励,已领取</p>
						</div>
				 		<span class="fr advanceRanks">助力提前3名次</span>
				 	</li>`
				})
				let listInnerHtml =`<ul>${listUser}</ul>`;
				$("#helpListContent").html(listInnerHtml);
				
			},
			initTotalHelpNum: function(){
				let randomNum = 15000 + Math.floor(Math.random()*10000)
				randomNum = this.format(randomNum)
				$("#personNumSpan").html(randomNum)
			},
			// 千位分割
			format: function(num) {
				var reg=/\d{1,3}(?=(\d{3})+$)/g; 
				return (num + '').replace(reg, '$&,');
			},
			init:function(){
				this.initTotalHelpNum();
				this.getUserDetail();
			
			}
		}
        renderHelpUser.init()
       
		$("#oneKeyhelpBtn").click(function(){
			$("#helpPageBox").hide();
			$("#mainContentBox").show();
		})


		// 滚动字幕
		let scrollTextObj ={
			getRandomMobile: function(){
				var prefixArray = ["13", "14", "15", "17", "18"];
				var i = parseInt(prefixArray.length * Math.random());
				var prefix = prefixArray[i];
				prefix += Math.floor(Math.random() * 10)
				prefix += "****"
				for (var j = 0; j < 4; j++) {
					prefix = prefix + Math.floor(Math.random() * 10);
				}
				return prefix;
			},
			addRewardText: function(){
				let str = ""
				for (var i = 0; i < randomLenth; i++) {
					let mobile = this.getRandomMobile()
					let rewardStr = "<p>手机号" + mobile + "已经领取10元</P>"
					str += rewardStr
				}
				$("#scrollText").html(str)
				let width = 270 * randomLenth + 10 + "px";
				$("#scrollText").css("width", width)
			},
			startScroll: function(){
				var MyMar = setInterval(Marquee, 80)  //设置定时器  
				let topBox = document.getElementById("topBox")
				function Marquee() {
					topBox.scrollLeft++
				}
			},
            init: function(){
				this.addRewardText();
				// 滚动
				this.startScroll();
			}
		}
		
		scrollTextObj.init()


		//渲染邀请人信息信息
		let renderUserDetail={
			getUserDetail: function(){
				$.ajax({
					type: "GET",
					url: `${server}/user/invitationRel/getInviterInfo?parentQrcode=${parentQrcode}`,
					success: function (res) {
						console.log(res)
						if (res.code == 200) {
							renderUserDetail.renderUDetailDom(res);
						}else{
							// $("#userBox").hide();
						}
					}
				})
			},
			renderUDetailDom(res){
				let nickName = res.data.nickName;
				let iconUrl = res.data.icon

				$("#helpHomeUser p").html(nickName);
				$("#userName").html(nickName);
				

				if (iconUrl) {
					$("#helpHomeUserIcon").css("backgroundImage","url("+ iconUrl + ")");
					$("#userIcon").css("backgroundImage", "url(" + iconUrl + ")");
				}
			},
			init:function(){
				this.getUserDetail();
			}
		}

		renderUserDetail.init();

		function hideInputFocus() {
			let hideInput = document.getElementById("hideInput");
			hideInput.focus();
			setTimeout(function () {
				hideInput.blur();
			}, 10)
		}
		
		// 解决ios上键盘弹起回落后，页面无法复原bug
         let resoveKeyBord ={
			init:function(){
				$("#submitMobile").blur(function () {
					hideInputFocus();
				})
				$("#codeInput").blur(function () {
					hideInputFocus();
				})
				document.body.addEventListener('focusout', function () {
					window.scrollTo(0, 0);
				});
			}
		 }


		 let testMobile = /^1[34578]\d{9}$/
		//手机号输入校验
		$("#submitMobile").on("keyup", function () {
			var $this = $(this)
			var value = $this.val();
			if(!value){
				return;
			}
			if (value.length > 11) {
				value = value.slice(0, 11);
				$("#submitMobile").val(value);
				console.log(value);
				return;
			}
			if (!testMobile.test(value)) {
				$("#errorMobile").show()
			} else {
				//验证通过
				$("#errorMobile").hide();
				console.log($("#submitBtn1"))
			}
		})

		//提交手机号页面1
		$("#submitBtn1").click(function () {
			let mobile = $("#submitMobile").val();
			if(!mobile){
				toastShow("请输入手机号");
				return;
			}
			if(!testMobile.test(mobile)){
				toastShow("手机号输入不合法");
				return;
			}
			
			checkMobile(mobile, function (res) {
				// == true 新用户， == false 老用户
				if (res) {
					//新用户跳转
					$("#bottomSubmitBox").hide();
					$("#registerBox").show();
					// 同步手机号信息
					$("#submitMobile2").val(mobile);
				} else {
					// 老用户 弹出提示窗
					$("#messageModal").fadeIn();
					$("#mainContentBox").addClass("notClick")
				}
			})
		})

		//发送验证码
		$("#sendCodeBtn").click(function () {
			hideInputFocus();
			var $this = $(this)
			$this.attr("disabled", true)
			$this.addClass("disableClick")
			//发送验证码请求
			sendCodeAjax()
			setTimeout("removeSendDisabled()", 60000)
		})

		//最终注册
		$("#submitBtn2").click(function () {
			hideInputFocus();
			codeInputValue = $("#codeInput").val();
			let selectAgree = $("#agreeRadio").hasClass("active");
			if (!codeInputValue) {
				toastShow("请输入短信验证码");
				return;
			}
			// 校验输入的验证码
			if (hasSendFlag && codeInputValue.length >= 4 && codeInputValue.length <= 6) {
				if (!selectAgree) {
					toastShow("请勾选同意服务条款");
					return;
				}
				lastSubmit()
			}
		})

		//最终注册
		function lastSubmit() {
			let mobile = $("#submitMobile").val();
			let postJson = {
				mobile: mobile,
				parentQrcode: parentQrcode,
				smsCode: codeInputValue,
				type: "H5HELP",
			}
			$.ajax({
				type: "post",
				data: postJson,
				url: `${server}/user/login/h5Register`,
				success: function (res) {
					console.log(res)
					//注册成功
					if (res.code == 200) {
						$("#registerBox").hide();
						$("#registerSuccessBox").show();
						setTimeout(function () {
							goStore();
						}, 3000)
					} else {
						toastShow("注册失败 !")
					}
				}
			})

		}

		//toast提示语
		function toastShow(message) {
			//验证码输入有误
			$("#toastMessageModal").html(message)
			$("#toastMessageModal").show();
			setTimeout(function () {
				$("#toastMessageModal").hide();
			}, 2000)
		}

		//注册成功跳转
		$("#goAppStoreBtn").click(function () {
			goStore();
		})


		//发送验证码
		function sendCodeAjax() {
			let mobile = $("#submitMobile").val();
			let postJson = {
				mobile: mobile,
				type: "SEND_LOGIN"
			}
			$.ajax({
				type: "post",
				data: postJson,
				url: `${server}/sys/sms/sendSmsCode`,
				success: function (res) {
					console.log(res)
					if (res.code == 200) {
						hasSendFlag = true
					} else {
						hasSendFlag = false
					}
				}
			})

		}

		//去掉不可点击状态
		function removeSendDisabled() {
			let $codeBtn = $("#sendCodeBtn")
			$codeBtn.attr("disabled", false)
			$codeBtn.removeClass("disableClick")
		}	


		// 验证手机号
		function checkMobile(mobile, Tback) {
			$.ajax({
				type: "GET",
				url: `${server}/user/login/h5CheckMobile?mobile=${mobile}`,
				success: function (res) {
					console.log(res)
					if (res.code == 200 || res.code == 400) {
						Tback(res.data)
					}
				}
			})
		}

		// 同意协议
		$("#agreeRadio").click(function () {
			let $this = $(this)
			if ($this.hasClass("active")) {
				$this.removeClass("active")
			} else {
				$this.addClass("active")
			}
		})		


		// 点击确认事件,已注册用户弹窗
		$("#messageOkBtn").click(() => {
			$("#messageModal").fadeOut();
			$("#mainContentBox").removeClass("notClick")
		})

		function goStore() {
			var u = navigator.userAgent, app = navigator.appVersion, ua = navigator.userAgent.toLowerCase();
			var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Linux') > -1; //android终端或者uc浏览器
			var isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
			if (isiOS) {
				window.location.href = applestore;
				window.event.returnvalue = false
			} else {
				// 跳到应用宝
				window.location.href = apkStore;
				window.event.returnvalue = false
			}
		}

		//获取地址栏参数拿到数据渲染
		function getRequest() {
			var url = window.location.search;
			//var url = '?liveId=21&shareUserId=148'; //获取url中"?"符后的字串

			var theRequest = new Object();

			if (url.indexOf("?") != -1) {
				var str = url.substr(1);
				strs = str.split("&");
				for (var i = 0; i < strs.length; i++) {
					let item = strs[i];
					let arrd = item.split("=");
					theRequest[arrd[0]] = arrd[1]
				}
			}
			return theRequest;
		}
		

	})()



</script>